package vulnerability

import (
	"context"
	"testing"

	"github.com/klamhq/facter-oss/pkg/options"
	schema "github.com/klamhq/facter-schema/proto/klamhq/rpc/facter/v1"
	"github.com/sirupsen/logrus"
	"github.com/stretchr/testify/assert"
)

func TestVulnerabilityCollectorImpl_New(t *testing.T) {
	logger := logrus.New()
	cfg := &options.VulnerabilitiesOptions{
		Enabled: true,
	}

	collector := New(logger, cfg)
	assert.NotNil(t, collector)
	assert.Equal(t, logger, collector.log)
	assert.Equal(t, cfg, collector.cfg)
}

func TestVulnerabilityCollectorImpl_CollectVulnerability_TrivyNotInstalled(t *testing.T) {
	logger := logrus.New()
	cfg := &options.VulnerabilitiesOptions{
		Enabled: true,
	}

	collector := New(logger, cfg)
	ctx := context.Background()
	packages := []*schema.Package{
		{
			Name:    "test-package",
			Version: "1.0.0",
		},
	}

	// This should fail because trivy is not installed in test environment
	report, err := collector.CollectVulnerability(ctx, packages)
	assert.Error(t, err)
	assert.Nil(t, report)
	assert.Contains(t, err.Error(), "trivy is not installed")
}

func TestVulnerabilityCollectorImpl_CollectVulnerability_EmptyPackages(t *testing.T) {
	logger := logrus.New()
	cfg := &options.VulnerabilitiesOptions{
		Enabled: true,
	}

	collector := New(logger, cfg)
	ctx := context.Background()
	packages := []*schema.Package{}

	// This should fail because trivy is not installed
	report, err := collector.CollectVulnerability(ctx, packages)
	assert.Error(t, err)
	assert.Nil(t, report)
}

func TestVulnerabilityCollectorImpl_CollectVulnerability_NilContext(t *testing.T) {
	logger := logrus.New()
	cfg := &options.VulnerabilitiesOptions{
		Enabled: true,
	}

	collector := New(logger, cfg)
	packages := []*schema.Package{
		{
			Name:    "test-package",
			Version: "1.0.0",
		},
	}

	// Use background context since we can't pass nil
	ctx := context.Background()
	report, err := collector.CollectVulnerability(ctx, packages)
	assert.Error(t, err)
	assert.Nil(t, report)
}
